//----------------------
// <auto-generated>
// </auto-generated>
//----------------------
using System;
using System.Threading.Tasks;
using System.Collections.Generic;
using LanguageExt;
using Newtonsoft.Json;

namespace Infusio.Http
{
    using static Prelude;
    using static Formatting;
    using static JsonConvert;

    public static class HttpSupport
    {
        public static Task<Either<InfusioError, T>> interpret<T>(InfusioOp<T> op, InfusioClient client) =>
            RunAsync(op, InfusioState.Create(useLogging: false), client).Match(
                Left: e => Left<InfusioError, T>(e),
                Right: r => r.Value
            );

        public static Task<Either<InfusioError, T>> Run<T>(this InfusioOp<T> op, InfusioClient client) =>
            RunAsync(op, InfusioState.Create(useLogging: false), client).Match(
                Left: e => Left<InfusioError, T>(e),
                Right: r => r.Value
            );

        public static Task<Either<InfusioError, InfusioResult<T>>> interpret<T>(InfusioOp<T> op, InfusioClient client, InfusioState state) =>
            RunAsync(op, state, client).ToEither();

        public static Task<Either<InfusioError, InfusioResult<T>>> Run<T>(this InfusioOp<T> op, InfusioClient client, InfusioState state) =>
            RunAsync(op, state, client).ToEither();

        public static Task<Either<InfusioError, InfusioResult<T>>> interpretWithLogs<T>(InfusioOp<T> op, InfusioClient client, IEnumerable<string> logs = default) =>
            RunAsync(op, InfusioState.Create(Seq(logs), useLogging: true), client).ToEither();

        public static Task<Either<InfusioError, InfusioResult<T>>> RunWithLogs<T>(this InfusioOp<T> op, InfusioClient client, IEnumerable<string> logs = default) =>
            RunAsync(op, InfusioState.Create(Seq(logs), useLogging: true), client).ToEither();

        static EitherAsync<InfusioError, InfusioResult<T>> RunAsync<T>(InfusioOp<T> op, InfusioState state, InfusioClient client) =>
            op is InfusioOp<T>.Return r ? Right<InfusioError, InfusioResult<T>>(new InfusioResult<T>(r.Value, state.Logs)).ToAsync() :
            op is InfusioOp<T>.Log l ? Exe(l, l, l.Next, state, client) :
{% for op in Operations -%}
            op is InfusioOp<T>.{{ op.Name }}{% assign op_name = forloop.index %} _{{ op_name }} ? Exe(_{{ op_name }}, _{{ op_name }}, _{{ op_name }}.Next, state, client) :
{% endfor -%}
            throw new NotSupportedException();

        static EitherAsync<InfusioError, InfusioResult<B>> Exe<T, B>(Show<InfusioOp<T>> show, HttpWorkflow<T> workflow, Func<T, InfusioOp<B>> nextOp, InfusioState state, InfusioClient client) =>
            from right in LogOperation(show, workflow, state, client).ToAsync()
            from next in RunAsync(nextOp(right.Value), right.State, client)
            select next;

        static Task<Either<InfusioError, (InfusioState State, T Value)>> LogOperation<T>(Show<InfusioOp<T>> show, HttpWorkflow<T> workflow, InfusioState state, InfusioClient client) =>
            from st in Right<InfusioError, (InfusioState, Unit)>((LogRequest(state, show), unit)).AsTask()
            from result in workflow(client).ToAsync().Match(
                Left: error => Left<InfusioError, (InfusioState, T)>(error),
                Right: value => Right<InfusioError, (InfusioState, T)>((LogResult(st.Item1, value), value))
            )
            select result;

        static InfusioState LogRequest<T>(InfusioState state, Show<InfusioOp<T>> show) =>
            state.UseLogging ? state.Log(show()) : state;

        static InfusioState LogResult<T>(InfusioState state, T value) =>
            typeof(T) == typeof(Unit) ? state :
            state.UseLogging ? state.Log($"OK: {SerializeObject(value, Indented)}") :
            state;

        public static Task<T> Unsafe<T>(this Task<Either<InfusioError, T>> self) =>
            self.ToAsync()
                .IfLeftAsync(e => throw new Exception(e.Value));
    }

    public enum InfusioLogging
    {
        WithLogs,
        WithoutLogs
    }

    class InfusioState
    {
        public static InfusioState Create(InfusioLogging logging) => new InfusioState(Seq<string>(), logging == InfusioLogging.WithLogs ? true : false);
        public static InfusioState Create(Seq<string> logs, InfusioLogging logging) => new InfusioState(logs, logging == InfusioLogging.WithLogs ? true : false);
        public readonly Seq<string> Logs;
        public readonly bool UseLogging;

        InfusioState(Seq<string> logs = default, bool useLogging = default)
        {
            Logs = logs;
            UseLogging = useLogging;
        }

        public InfusioState Log(string message) =>
            new InfusioState(Logs.Append(Seq1(message)), UseLogging);
    }
}